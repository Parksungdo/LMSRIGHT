<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.happyjob.study.tut.dao.LecturePlanListDAO">

   <!-- 강의 목록 조회 -->
   <select id="lecturePlanListSearch" resultType="kr.happyjob.study.tut.model.LecturePlanListModel">
      /*kr.happyjob.study.tut.dao.LecturePlanListDAO.lecturePlanListSearch*/      
		select tl.lecture_seq
		      , tl.loginID
		      , ui.name
		      , tl.test_no
		      , tl.lecture_no
		      , dc.detail_name as lecture_name
		      , tl.lecture_person
		      , tl.lecture_total
		      , tl.lecture_goal
		      , tl.lecture_start
		      , tl.lecture_end
		      , tl.lecture_confirm
		  from tb_lecture tl
		    inner join tb_detail_code dc on dc.group_code = 'lecture_no' and dc.detail_code = tl.lecture_no
		    inner join tb_userinfo ui on tl.loginID = ui.loginID
          	<where>
          		tl.loginID = #{loginID}
				<if test="(lectureNameSearch != null) and (!lectureNameSearch.equals(''))">
				      and detail_name LIKE CONCAT('%', #{lectureNameSearch}, '%')      	
				</if>
			</where>
       LIMIT #{startnum}, #{pageSize}
   </select>
   
   <!-- 강의 목록 총 갯수 조회 -->
   <select id="lecturePlanListCnt" resultType="int">
      /*kr.happyjob.study.tut.dao.LectureListDAO.lecturePlanListCnt*/      
      SELECT	count(*)
		  from tb_lecture tl
		    inner join tb_detail_code dc on dc.group_code = 'lecture_no' and dc.detail_code = tl.lecture_no
        WHERE tl.loginID = #{loginID}
   </select>
   
   <!-- 강의 상세보기 -->
   <select id="LecturePlanSelect" resultType="kr.happyjob.study.tut.model.LecturePlanListModel">
      /*kr.happyjob.study.tut.dao.LecturePlanListDAO.LecturePlanSelect*/      
		select tl.lecture_seq
		      , tl.loginID
		      , ui.name
		      , tl.test_no
		      , tl.lecture_no
		      , dc.detail_name as lecture_name
		      , tl.lecture_person
		      , tl.lecture_total
		      , tl.lecture_goal
		      , tl.lecture_start
		      , tl.lecture_end
		      , tl.lecture_confirm
		  from tb_lecture tl
		    inner join tb_detail_code dc on dc.group_code = 'lecture_no' and dc.detail_code = tl.lecture_no
		    inner join tb_userinfo ui on tl.loginID = ui.loginID
        WHERE   tl.lecture_seq = #{lectureseq}
        AND		tl.loginID = #{loginID}
   </select>
   
   <!-- 강의 주차별계획 목록 -->
   <select id="weekPlanList" resultType="kr.happyjob.study.tut.model.WeekPlanListModel">
      /*kr.happyjob.study.tut.dao.LecturePlanListDAO.weekPlanList*/      
		select tp.lecture_seq
		      , tp.plan_no
		      , tl.lecture_no
		      , tp.plan_week
		      , tp.plan_goal
		      , tp.plan_content
		      , tp.plan_start
		      , tp.plan_end
		  from tb_plan tp
		    inner join tb_lecture tl on tl.lecture_seq = tp.lecture_seq
        WHERE   tp.lecture_seq = #{lectureseq}
        ORDER BY plan_no
		LIMIT #{startnum}, #{pageSize}
   </select>
   
   <!-- 강의 주차별계획 목록 -->
   <select id="weekPlanListCnt" resultType="int">
      /*kr.happyjob.study.tut.dao.LecturePlanListDAO.weekPlanListCnt*/      
       SELECT	count(*)
		  from tb_plan tp
		    inner join tb_lecture tl on tl.lecture_seq = tp.lecture_seq
        WHERE   tp.lecture_seq = #{lectureseq}
   </select>
   
   <!-- 강의 주차별계획 선택 -->
   <select id="weekselect" resultType="kr.happyjob.study.tut.model.WeekPlanListModel">
      /*kr.happyjob.study.tut.dao.LecturePlanListDAO.weekselect*/      
		select tp.lecture_seq
		      , tp.plan_no
		      , tl.lecture_no
		      , tp.plan_week
		      , tp.plan_goal
		      , tp.plan_content
		      , tp.plan_start
		      , tp.plan_end
		  from tb_plan tp
		    inner join tb_lecture tl on tl.lecture_seq = tp.lecture_seq
        WHERE   tp.lecture_seq = #{lectureseq}
        AND		plan_no = #{plan_no}
   </select>
   
   <insert id="weekinsert">
		<selectKey resultType="int" keyProperty="newweekplan" order="BEFORE">
			select ifnull(max(plan_no + 1), 1) from tb_plan
		</selectKey>
		insert into tb_plan
			(
				  lecture_seq
				, plan_no
				, plan_week
				, plan_goal
				, plan_content
				, plan_start
				, plan_end
			) value (
				  #{lectureseq}
				, #{newweekplan}
				, #{plan_week}
				, #{plan_goal}
				, #{plan_content}
				, #{plan_start}
				, #{plan_end}
			)
	</insert>
	
	<update id="weekupdate">
		update tb_plan
			set plan_week = #{plan_week}
				, plan_goal = #{plan_goal}
				, plan_content = #{plan_content}
				, plan_start = #{plan_start}
				, plan_end = #{plan_end}
			where plan_no = #{plan_no}
			and lecture_seq = #{lectureseq}
	</update>
	
	<delete id="weekdelete">
        delete from tb_plan
		 where plan_no = (
                            select ll.plan_no
                              from (
                                     select max(tps.plan_no)  as plan_no
                                       from tb_plan tps 
                                       where tps.lecture_seq = #{lectureseq}
                                   ) ll
                         )
		   and lecture_seq = #{lectureseq}		   
	</delete>
   
</mapper>